{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">积分充值</h2>

                    <!-- 充值选项 -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card pricing-card h-100">
                                <div class="card-body text-center">
                                    <h4>¥9.9</h4>
                                    <p>100积分</p>
                                    <p class="text-muted">约500次基础调用</p>
                                    <button class="btn btn-primary recharge-btn" data-amount="9.9"
                                        data-credits="100">立即充值</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card pricing-card h-100">
                                <div class="card-body text-center">
                                    <h4>¥29.9</h4>
                                    <p>500积分</p>
                                    <p class="text-muted">约2500次基础调用</p>
                                    <button class="btn btn-primary recharge-btn" data-amount="29.9"
                                        data-credits="500">立即充值</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card pricing-card h-100">
                                <div class="card-body text-center">
                                    <h4>¥49.9</h4>
                                    <p>1000积分</p>
                                    <p class="text-muted">约5000次基础调用</p>
                                    <button class="btn btn-primary recharge-btn" data-amount="49.9"
                                        data-credits="1000">立即充值</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 自定义金额 -->
                    <div class="row mt-4">
                        <div class="col-md-6 offset-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4>自定义金额</h4>
                                    <p>1元=1积分</p>
                                    <div class="input-group mb-3">
                                        <input type="number" class="form-control" id="customAmount" placeholder="输入金额">
                                        <button class="btn btn-primary" onclick="rechargeCustom()">充值</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 测试订单按钮 -->
                    <div class="row mt-4">
                        <div class="col-md-6 offset-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4>测试订单</h4>
                                    <p>0.01元测试支付</p>
                                    <button class="btn btn-warning" onclick="createTestOrder()">创建测试订单</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 支付二维码弹窗 -->
<div class="modal fade" id="payModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">微信支付</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode"></div>
                <p class="mt-3">请使用微信扫描二维码支付</p>
                <p class="text-muted">订单号：<span id="orderNo"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- 引入qrcode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
    // 创建测试订单
    function createTestOrder() {
        recharge(0.01, 1);
    }

    // 充值函数
    function recharge(amount, credits) {
        fetch('/api/order/make/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                amount: amount,
                credits: credits
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 显示支付二维码
                    showPayQRCode(data.data.code_url, data.data.order_no);
                } else {
                    alert(data.msg || '创建订单失败');
                }
            })
            .catch(error => {
                alert('创建订单失败，请稍后重试');
            });
    }

    // 自定义金额充值
    function rechargeCustom() {
        const amount = document.getElementById('customAmount').value;
        if (amount > 0) {
            recharge(amount, Math.floor(amount));
        } else {
            alert('请输入有效的充值金额');
        }
    }

    // 显示支付二维码
    function showPayQRCode(codeUrl, orderNo) {
        // 清空之前的二维码
        document.getElementById('qrcode').innerHTML = '';

        // 显示订单号
        document.getElementById('orderNo').textContent = orderNo;

        // 生成新的二维码
        new QRCode(document.getElementById('qrcode'), {
            text: codeUrl,
            width: 200,
            height: 200
        });

        // 显示弹窗
        new bootstrap.Modal(document.getElementById('payModal')).show();

        // 开始轮询订单状态
        startPollingOrderStatus(orderNo);
    }

    // 轮询订单状态
    function startPollingOrderStatus(orderNo) {
        const checkOrder = () => {

            fetch(`/api/order/status/${orderNo}/`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'paid') {
                        // 支付成功，关闭弹窗并刷新页面
                        bootstrap.Modal.getInstance(document.getElementById('payModal')).hide();
                        window.location.reload();
                    } else if (data.status === 'pending') {
                        // 继续轮询
                        setTimeout(checkOrder, 3000);
                    }
                });
        };

        // 开始轮询
        checkOrder();
    }

    // 为所有充值按钮添加事件监听
    document.querySelectorAll('.recharge-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const amount = parseFloat(this.dataset.amount);
            const credits = parseInt(this.dataset.credits);
            recharge(amount, credits);
        });
    });
</script>

<style>
    .pricing-card {
        transition: transform 0.3s;
    }

    .pricing-card:hover {
        transform: translateY(-5px);
    }

    #qrcode {
        display: inline-block;
        padding: 10px;
        background: white;
        border-radius: 5px;
    }
</style>
{% endblock %}